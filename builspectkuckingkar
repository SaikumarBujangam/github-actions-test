version: 0.2

parameters:
    
env:
  variables:
    TARGET_REGION: "eu-central-1"
    TARGET_BUCKET: "test-61923"
    SOURCE_BUCKET: "codepipeline-eu-central-1-70758803032"

phases:
  build:
    commands:
      - aws configure set region $TARGET_REGION --profile dev-account
      - aws configure set role_arn arn:aws:iam::745252665765:role/InfraBuildRole --profile dev-account
      - aws configure set credential_source EcsContainer --profile dev-account
      - echo "Listing Build Artifacts in ${SOURCE_BUCKET}/dev-webapp-pipeline-/BuildArtif/"
      - aws s3 ls s3://${SOURCE_BUCKET}/dev-webapp-pipeline-/BuildArtif/ | sort
      - echo "Getting the latest Build Artifact"
      - latest_object=$(aws s3 ls s3://${SOURCE_BUCKET}/dev-webapp-pipeline-/BuildArtif/ | sort | tail -n 1 | awk '{print $4}')
      - echo "Copying $latest_object Artifact from s3://${SOURCE_BUCKET}/dev-webapp-pipeline-/BuildArtif/"
      - aws s3 cp s3://${SOURCE_BUCKET}/dev-webapp-pipeline-/BuildArtif/$latest_object .
      - ls -lrt
      - echo "Extracting the files from $latest_object"
      - unzip *
      - ls -lrt
      - rm -rf $latest_object
      - ls -lrt
      - aws s3 rm --recursive s3://${TARGET_BUCKET} --profile dev-account
      - echo "Deploying the files to ${TARGET_BUCKET}"
      - aws s3 cp . s3://${TARGET_BUCKET}/ --recursive
