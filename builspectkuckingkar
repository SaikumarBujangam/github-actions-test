locals {
  base_rules = [
    {
      ResourceType = "collection",
      Resource = [
        "collection/${var.oss_collection_name}"
      ]
    }
  ]

  dashboard_rules = var.enable_dashboard_access ? [
    {
      ResourceType = "dashboard",
      Resource = [
        "collection/${var.oss_collection_name}"
      ]
    }
  ] : []

  combined_rules = concat(local.base_rules, local.dashboard_rules)
}

resource "aws_opensearchserverless_security_policy" "oss_security_network_policy_vpc_access" {
  name        = var.oss_security_network_policy_vpc_access_name
  type        = "network"
  description = "VPC access"
  policy = jsonencode([{
    Description      = "VPC access to collection and Dashboards endpoint for ${var.oss_collection_name} collection",
    AllowFromPublic = false,
    SourceVPCEs     = var.source_vpc_list,
    Rules           = local.combined_rules
  }])
}

variable "enable_dashboard_access" {
  description = "A boolean flag to enable or disable dashboard access"
  type        = bool
  default     = false # or true, depending on what you want the default to be
}
