#####################################
# Project On Demand JUPYTER Instance
#####################################

resource "aws_sagemaker_notebook_instance" "starcap_jupyter" {
  
  name                  = var.jupyter_notebook_name
  instance_type         = var.jupyter_instance_type
  role_arn              = aws_iam_role.sagemaker_role.arn
  subnet_id             = var.subnet_ids[0]
  security_groups       = [aws_security_group.notebook_security_group.id]
  lifecycle_config_name = aws_sagemaker_notebook_instance_lifecycle_configuration.jupyter_lc.id
  root_access           = "Disabled"
  tags                  = var.tags
 
  # platform_identifier = var.platform_identifier

  depends_on = [
    aws_sagemaker_notebook_instance_lifecycle_configuration.jupyter_lc
  ]
}

resource "aws_sagemaker_notebook_instance_lifecycle_configuration" "jupyter_lc" {
  name  = "${var.platform}-${var.jupyter_notebook_name}-policy"
  
  on_start = base64encode(templatefile("${path.module}/templates/on_start_mount.tpl", {
        proj_raw_fsx_mount      = var.raw_fsx_mount,
        proj_raw_fsx_dns        = var.raw_fsx_dns,
        proj_scratch_fsx_dns    = var.scratch_fsx_dns,
        proj_scratch_fsx_mount  = var.scratch_fsx_mount
      }))
}

resource "aws_security_group" "notebook_security_group" {
  name        = "notebook-security-group"
  description = "Security group for Amazon SageMaker Notebook Instance"

  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]  
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]  
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"  
    cidr_blocks = ["0.0.0.0/0"] 
  }
}


