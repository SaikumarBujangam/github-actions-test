resource "aws_cloudwatch_event_target" "codebuild" {
  count     = module.docker_build.create_build_project ? 1 : 0
  rule      = aws_cloudwatch_event_rule.trigger_build_on_tag_updates.name
  target_id = "TriggerCodeBuild"
  arn       = module.docker_build.codebuild_project_arn[count.index]
  role_arn  = aws_iam_role.cloudwatch_event_role.arn

  input_transformer {
    input_paths = {
      git_tag = "$.detail.referenceName"
    }
    input_template = "{ \"environmentVariablesOverride\": [ { \"name\": \"TAG\", \"value\": <git_tag> }, { \"name\": \"SOURCETRIGGER\", \"value\": \"REPO_TAG\" } ]}"
  }
}
