provider "aws" {
  region = "your-region"
}

resource "aws_cloud9_environment_ec2" "cloud9_env" {
  name           = "MyCloud9Environment"
  description    = "AWS Cloud9 Environment for CodeCommit"
  instance_type  = "t2.micro"  # Adjust the instance type as needed

  subnet_id      = "subnet-id"  # Specify the subnet ID for your VPC
  automatic_stop_time_minutes = 30  # Set the automatic stop time in minutes

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_iam_role" "cloud9_role" {
  name = "Cloud9CodeCommitRole"

  assume_role_policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF
}

resource "aws_iam_policy" "cloud9_policy" {
  name = "Cloud9CodeCommitPolicy"

  policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "codecommit:ListRepositories",
        "codecommit:GitPull",
        "codecommit:UploadArchive",
        "codecommit:CancelUploadArchive",
        "codecommit:GetBranch",
        "codecommit:GetCommit",
        "codecommit:GetUploadArchiveStatus",
        "codecommit:UploadArchive",
        "codecommit:CancelUploadArchive"
      ],
      "Resource": "*"
    }
  ]
}
EOF
}

resource "aws_iam_role_policy_attachment" "cloud9_policy_attachment" {
  policy_arn = aws_iam_policy.cloud9_policy.arn
  role       = aws_iam_role.cloud9_role.name
}

resource "aws_cloud9_environment_membership" "cloud9_membership" {
  environment_id = aws_cloud9_environment_ec2.cloud9_env.id
  user_arns      = ["arn:aws:iam::account-id:user/your-username"]
  permissions    = "read-write"
}
