version: 0.2
env:
  variables:
    TARGET_REGION: "eu-central-1"
    ENV: ""
    SERVICES_TO_RESTART: ""
  secrets-manager:
    Endor_Graphql_Api_Key: "$ENV/variable/endorGraphqlApiKey"
    Service_Access_Key: "$ENV/variable/serviceAccessKey"
phases:
  install:
    runtime-versions:
        java: corretto17
  pre_build:
    commands:
      - echo "Validating environment parameter"
      - |
        if [ "$ENV" != "qa" ] && [ "$ENV" != "stg" ] && [ "$ENV" != "prod" ]; then
          echo "Invalid environment paramter. Accepted values are 'qa', 'stg' or 'prod'."
          exit 1
        fi 
      - aws configure set region $TARGET_REGION --profile $ENV-account
      - aws configure set role_arn arn:aws:iam::745252665765:role/InfraBuildRole --profile $ENV-account
      - aws configure set credential_source EcsContainer --profile $ENV-account
      - aws eks --region $TARGET_REGION update-kubeconfig --name $ENV-starcap-platform-cluster --profile $ENV-account
  build:
    commands:
      - |
        IFS=',' read -ra SERVICES <<< "$SERVICES_TO_RESTART"
        for service in $SERVICES[@]; do
          kubectl rollout restart deployment $service -n backend
        done
