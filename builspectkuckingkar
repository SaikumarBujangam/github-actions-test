#!/bin/bash

set -e

# OVERVIEW
# This script mounts a FSx for Lustre file system to the Notebook Instance at the /fsx directory based off
# the DNS and Mount name parameters.
# This script assumes the following:
#   1. There's an FSx for Lustre file system created and running
#   2. The FSx for Lustre file system is accessible from the Notebook Instance
#       - The Notebook Instance has to be created on the same VPN as the FSx for Lustre file system
#       - The subnets and security groups have to be properly set up
#   3. Set the FSX_DNS_NAME parameter below to the DNS name of the FSx for Lustre file system.
#   4. Set the FSX_MOUNT_NAME parameter below to the Mount name of the FSx for Lustre file system.

# PARAMETERS
#FSX_DNS_NAME=fs-05c36a7d4ea286b75.fsx.eu-central-1.amazonaws.com
#FSX_MOUNT_NAME=zgakjbmv

# Production Bug for Jupyter not spinning starts
CURR_VERSION_AL=$(cat /etc/system-release)

# First, we need to install the lustre-client libraries

if [[ $CURR_VERSION_AL == *$" release 2018"* ]]; then
    sudo yum install -y lustre-client
else 
    sudo amazon-linux-extras install -y lustre2.10
fi
# Production Bug for Jupyter not spinning ends

# Now we can create the mount point and mount the file system

sudo mkdir /home/ec2-user/SageMaker/rawfsx

sudo mount -t lustre -o noatime,flock ${proj_raw_fsx_dns}@tcp:/${proj_raw_fsx_mount} /home/ec2-user/SageMaker/rawfsx

# Let's make sure we have the appropriate access to the directory

sudo chmod go+rw /home/ec2-user/SageMaker/rawfsx

sudo mkdir /home/ec2-user/SageMaker/scratchfsx

sudo mount -t lustre -o noatime,flock ${proj_scratch_fsx_dns}@tcp:/${proj_scratch_fsx_mount} /home/ec2-user/SageMaker/scratchfsx

# Let's make sure we have the appropriate access to the directory

sudo chmod go+rw /home/ec2-user/SageMaker/scratchfsx
