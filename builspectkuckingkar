name: ADL CICD Checkout Postgres Phase

on:
  workflow_call:
    secrets:
      envPAT:
        required: true
    inputs:
      cicd_version:
        description: 'CICD Stable Release Version'
        type: string
        required: false
        default: 'd1.0.285'

jobs:
  adl-checkout-calling-repo:
    runs-on: [self-hosted, devops-control-prod]

    steps:
    - name: Debug
      run: |
        pwd
        ls -al

    - name: Checkout Repository
      uses: actions/checkout@master

    - name: Checkout Requesting Repository Branch
      run: |
        echo "Checking out Repository: $GITHUB_REPOSITORY"
        echo "Checking out Branch: $GITHUB_REF_NAME"

    - name: Show Repository and Branch Info
      run: |
        echo "Checking out Repository: $GITHUB_REPOSITORY"
        echo "Checking out Branch: $GITHUB_REF_NAME"

  adl-dispatch-postgres-deploy-workflow:
    needs:
      - adl-checkout-calling-repo
    runs-on: [self-hosted, devops-control-prod]

    steps:
    - name: Trigger Postgres Deploy
      run: |
        curl -X POST https://api.github.com/repos/AlightEngineering/adl-awsdeploy-cicd/dispatches \
          -H "Authorization: Bearer ${{ secrets.envPAT }}" \
          -H 'Accept: application/vnd.github.everest-preview+json' \
          --data '{"event_type": "adl-postgres-deploy", "client_payload": { "name": "'"$GITHUB_REPOSITORY"'", "branch": "'"$GITHUB_REF_NAME"'", "cicd_version": "${{ inputs.cicd_version }}" }'
